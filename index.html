<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <title>ElevenLabs TTS (WebFlux)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root { --bg:#0b1020; --fg:#e8ecf1; --muted:#9aa6b2; --card:#141b34; --accent:#5b8def; --danger:#ff6b6b; }
        * { box-sizing: border-box; }
        body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; background:var(--bg); color:var(--fg); }
        .wrap { max-width: 840px; margin: 40px auto; padding: 0 16px; }
        .card { background:var(--card); border-radius:16px; padding:20px; box-shadow: 0 10px 28px rgba(0,0,0,.25); }
        h1 { margin: 0 0 8px; font-size: 24px; }
        p.sub { margin:0 0 16px; color:var(--muted); }
        label { display:block; margin:12px 0 6px; color:#cdd6df; font-weight:600; }
        input, textarea, select {
            width:100%; background:#0f152a; color:var(--fg); border:1px solid #22305c;
            border-radius:12px; padding:12px 14px; outline:none; font-size:16px;
        }
        textarea { min-height: 100px; resize: vertical; }
        .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
        .actions { display:flex; gap:12px; margin-top:16px; }
        button {
            appearance:none; border:none; padding:12px 16px; border-radius:12px; font-weight:700; cursor:pointer;
            background:var(--accent); color:white; transition: transform .06s ease, opacity .2s ease;
        }
        button:hover { transform: translateY(-1px); }
        button.secondary { background:#1b274b; color:#d8e2f0; }
        button.danger { background:var(--danger); }
        .status { margin-top: 10px; font-size: 14px; color:var(--muted); }
        .audio-wrap { margin-top:16px; background:#0f152a; border:1px solid #22305c; border-radius:12px; padding:12px; }
        footer { margin:28px 0 0; color:var(--muted); font-size:13px; text-align:center; }
        .hint { font-size: 13px; color: var(--muted); }
    </style>
</head>
<body>
<div class="wrap">
    <div class="card">
        <h1>Texto → Voz (ElevenLabs)</h1>
        <p class="sub">Digite um texto, selecione a voz e clique em <b>Gerar &amp; Tocar</b>.</p>

        <label for="text">Texto</label>
        <textarea id="text" placeholder="Escreva aqui o que deseja ouvir...">Olá! Este é um teste de streaming de áudio em tempo real usando Spring WebFlux e ElevenLabs.</textarea>

        <div class="row">
            <div>
                <label for="voiceId">Voice ID <span class="hint">(ex: QVAas5gGwu8nTdZ3MUpQ)</span></label>
                <input id="voiceId" placeholder="Deixe vazio para usar o padrão do servidor" />
            </div>
            <div>
                <label for="modelId">Model ID <span class="hint">(opcional)</span></label>
                <input id="modelId" placeholder="ex: eleven_turbo_v2_5 ou eleven_multilingual_v2" />
            </div>
        </div>

        <div class="actions">
            <button id="playBtn">Gerar &amp; Tocar</button>
            <button id="stopBtn" class="secondary">Parar</button>
            <button id="clearBtn" class="danger">Limpar áudio</button>
        </div>

        <div class="status" id="status">Pronto.</div>

        <div class="audio-wrap">
            <audio id="player" controls preload="none"></audio>
        </div>

        <footer>
            Dica: se hospedar este HTML fora do backend, habilite CORS no endpoint <code>/tts/stream</code>.
        </footer>
    </div>
</div>

<script>
    const BASE_URL = "http://localhost:8080";

    const $text = document.getElementById('text');
    const $voiceId = document.getElementById('voiceId');
    const $modelId = document.getElementById('modelId');
    const $play = document.getElementById('playBtn');
    const $stop = document.getElementById('stopBtn');
    const $clear = document.getElementById('clearBtn');
    const $status = document.getElementById('status');
    const $player = document.getElementById('player');

    function buildStreamUrl() {
        const params = new URLSearchParams();
        params.set('text', $text.value || ' ');
        return `${BASE_URL}/tts/stream?${params.toString()}`;
    }

    async function play() {
        try {
            const url = buildStreamUrl();
            $status.textContent = 'Gerando e tocando...';
            $player.src = url;
            // Toca assim que o browser tiver dados suficientes
            await $player.play();
            $status.textContent = 'Reproduzindo (stream).';
        } catch (e) {
            console.error(e);
            $status.textContent = 'Falha ao iniciar reprodução.';
        }
    }

    function stop() {
        $player.pause();
        $status.textContent = 'Pausado.';
    }

    function clearAudio() {
        // interrompe e solta a URL
        $player.pause();
        $player.removeAttribute('src');
        $player.load();
        $status.textContent = 'Áudio limpo.';
    }

    $play.addEventListener('click', play);
    $stop.addEventListener('click', stop);
    $clear.addEventListener('click', clearAudio);
</script>
</body>
</html>
